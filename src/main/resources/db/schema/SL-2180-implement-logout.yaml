databaseChangeLog:
- changeSet:
    id: create-user_tokens-table
    author: gsedgwick
    changes:
    - createTable:
        tableName: user_tokens
        columns:
        - column:
            name: id
            type: UUID
            constraints:
              nullable: false
        - column:
            name: user_id
            type: int
            constraints:
              foreignKeyName: fk_user_tokens_user
              references: user_data(id)
              nullable: false
        - column:
            name: max_expiry
            type: datetime
            constraints:
              nullable: false
    - addPrimaryKey:
        columnNames: id
        constraintName: pk_user_tokens
        schemaName: public
        tableName: user_tokens
    - createProcedure:
        dbms: postgresql
        procedureBody: |-
          CREATE OR REPLACE FUNCTION user_tokens_clear_expired() RETURNS trigger
            AS $$
              BEGIN
                DELETE FROM user_tokens WHERE now() > max_expiry;
                RETURN NULL;
              END;
            $$ LANGUAGE plpgsql;
    - sql:
        dbms: postgresql
        splitStatements: false
        sql: |-
          DROP TRIGGER IF EXISTS user_tokens_trigger ON user_tokens;
          CREATE TRIGGER user_tokens_trigger AFTER INSERT ON user_tokens
            FOR EACH STATEMENT EXECUTE PROCEDURE user_tokens_clear_expired();
